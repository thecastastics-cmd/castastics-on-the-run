<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castastics Master Runner</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; touch-action: none; color: white; }
        #gameUI { position: absolute; top: 10px; left: 15px; z-index: 10; pointer-events: none; text-shadow: 2px 2px #000; width: 100%; }
        
        /* Mission Banner */
        #levelBanner { color: #00ffff; font-size: 14px; background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 20px; display: inline-block; margin-bottom: 5px; border: 1px solid #00ffff; }
        
        #levelUpMsg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); color: #ffd700; font-size: 45px; z-index: 50; text-shadow: 0 0 20px #fff; pointer-events: none; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; }
        #levelUpMsg.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }

        #menu, #reviveMenu, #previewer { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; padding: 20px; text-align: center; }
        #reviveMenu, #previewer { display: none; z-index: 25; }
        
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; max-height: 40vh; overflow-y: scroll; padding: 10px; border: 2px solid #444; background: #111; width: 90%; border-radius: 10px; }
        .char-card { border: 2px solid #444; padding: 8px; text-align: center; border-radius: 8px; background: #222; font-size: 10px; }
        .char-card.selected { border-color: #00ff00; background: #004400; }
        
        #largeImg { width: 180px; height: 180px; object-fit: contain; margin: 20px 0; border: 4px solid #00ff00; border-radius: 15px; background: #111; padding: 10px; }
        button { padding: 18px 40px; font-size: 22px; background: #00ff00; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; color: #000; margin: 5px; }
        .secondary-btn { background: #555; color: white; font-size: 16px; padding: 10px 25px; }
        
        #muteBtn { position: absolute; bottom: 20px; right: 20px; background: #333; color: white; border-radius: 50%; width: 45px; height: 45px; border: none; z-index: 30; }
        #pauseBtn { position: absolute; top: 15px; right: 15px; z-index: 30; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 15px; border-radius: 5px; pointer-events: auto; }
    </style>
</head>
<body>

<div id="gameUI">
    <div id="levelBanner">LVL <span id="curLvl">1</span>: <span id="taskText">Loading...</span></div>
    <div style="color: #ffd700; font-size: 28px;">ðŸª™ <span id="coinCount">0</span></div>
    <div style="font-size: 14px; opacity:0.8; color: #00ff00;">BEST: <span id="highScoreDisplay">0</span></div>
    <div style="font-size: 18px;">SCORE: <span id="scoreDisplay">0</span></div>
    <div id="powerNotify" style="font-weight:bold; margin-top:5px; text-shadow: 0 0 5px #000;"></div>
    <button id="pauseBtn" onclick="togglePause()">PAUSE</button>
</div>

<div id="levelUpMsg">LEVEL UP! +ðŸª™BONUS</div>

<div id="menu">
    <h1 style="color:#00ff00; margin: 0; font-style: italic; cursor: pointer; pointer-events: auto;" onclick="checkCheat()">CASTASTICS</h1>
    <div style="color:#00ffff; font-size: 14px;">RANK: MASTER LEVEL <span id="menuLvl">1</span></div>
    <div style="color:#ffd700; margin: 5px 0;">BANK: ðŸª™ <span id="totalCoinsDisplay">0</span></div>
    <div class="char-grid" id="charGrid"></div>
    <button onclick="startGame()">RUN!</button>
</div>

<div id="previewer">
    <h2 id="previewName">CHARACTER NAME</h2>
    <div id="abilityText" style="color:#00ffff; font-size:12px; margin-bottom:5px;"></div>
    <img id="largeImg" src="" alt="Preview" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
    <div id="previewStatus" style="margin-bottom: 20px; font-weight: bold;">COST: ðŸª™100</div>
    <button id="previewActionBtn" onclick="handlePreviewAction()">SELECT</button>
    <button class="secondary-btn" onclick="closePreviewer()">BACK</button>
</div>

<div id="reviveMenu">
    <h2 style="color:#ffd700;">CRASHED!</h2>
    <p>Revive for ðŸª™ <span id="reviveCostText">5</span>?</p>
    <button onclick="revivePlayer()">REVIVE</button>
    <button class="secondary-btn" onclick="endGamePermanently()">NO THANKS</button>
</div>

<button id="muteBtn" onclick="toggleMute()">ðŸ”Š</button>
<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const castaNames = ["David Artsy", "Smacken", "Smacky", "A-Bomb", "Dennis The Menace", "Greg Heffley", "Nate Wright", "Kool Kid", "Girl Stick", "Hulk Ninja", "Master Stick", "Bee", "Inky", "Lego Spy Girl", "Circle", "Square", "Triangle", "Rectangle", "Lego Jet-Man", "Lego Bubble Boy", "Mrs. FruitÃ³", "Wheezy", "Whizzy", "Noobie", "Boxlunch Killer/Paul", "Joel", "Jet-Man", "Spy Girl", "The Artist", "Art Girl", "Bubble Boy", "Stronge", "James The Watch", "Gold Chain/Chinea", "Queen Bee/Sabrina", "Key/Jordan", "Lock/Harry", "Danny/Klipper Knight", "Dart", "Screw", "Speedy", "Zipper", "Radio", "Silver Chain", "Steele", "Scissors/Silvia", "Silver Watch", "Jesus", "Santa", "Max", "Sam", "White", "Black", "Rex", "Trixie", "Jace", "Rowan", "Lily", "Mia", "Petria", "Stampy", "Blitz Bot", "Velo", "DenisDaily", "Snake", "Walrus", "Fishy", "Dr. Evil Baby Head", "Blue", "Joel/Box Boy", "Mr. FruitÃ³", "Mud Man", "Yellow", "Catty", "Exterminator", "Kevin Duplop/Bug Man", "Carla and Boyo", "Green", "BOX-Man", "Jenna the Haxter", "Pollo", "Memo", "Dustin", "Terryann", "Balloon Man", "Toy Maker", "Lola", "Oscar", "Mia", "Lego Stronge", "Cheese Man", "Chase", "Squishy", "Star", "Rock Man", "Lego The Artist", "Crab", "Pedro", "Chranos", "Grymph", "The Admin", "Unstoppable Metal Beast", "Vanny/Swords Girl", "Super Spy Nick", "Bacon Hair Ryan", "Ian Alleyne", "1999 Jet-Man", "1999 Spy Girl", "1999 The Artist", "1999 Stronge", "1999 Bubble Man", "Jaquan/Spider Glue", "Nate Skywalker", "Brian/The Guitarist", "Spider Guy", "Shiann Padme", "Glue", "Talking Angela", "Alex/Big Foot", "Harry/Covered", "Lion Man", "Ishmell/Oh Mikkey Giggey Goo", "Roger/Car Man/Tank", "Jeremy/Stretcho", "Ian/Spider Glue", "Jade/Moon Witch", "Dark Shadow", "Sanjay/Slug Man", "Zach/SwordsMan", "Darker", "Black Beard", "Angela", "Ginger", "Tom", "Jerry", "Tom", "Spongebob RectanglePants", "Jake", "Annie", "David", "Chicken", "Jake (Subway Surfers)", "Venom", "Spider-Man", "Pac-Man", "Whom Whom Head/Whomie", "Bat Thumb", "Thumby", "BlackBeard", "Donnie", "Husky", "Ella", "Carmen (Lizard)", "Sabrina", "Adrien", "Toodos", "Pinching Girl", "Gothic Shadow", "Super Noob", "Kelian/Arrow Boy", "Flame", "Light", "Ice Jake", "The Artist (Jeremy)", "Spy Girl (Whitney)", "Inferno", "SwordsMan (Eren)", "Mega Boy (Adam)", "Johnny Jerickson/Fire Pen", "Ezekiel Johnson/Space Pen", "Ronal King/Unbreakable Pen", "Ivan DÃ©l Rio/Ice Pen", "Jenny Herickson/Space Princess", "Gabby Charles/Pendi Queen", "Buzz Lightyear", "Sheriff Woody", "Bella The Pig", "Goofy", "Marty/Speed Demon", "Joey Bear", "Carmen", "Super Magnet", "Three", "Hannah", "Kenny", "Little X Jr.", "Roger/Richard", "Ice", "Stephen", "Globe", "Frank The Pencil", "Ruler", "Eddie", "Blue", "Sabrina", "Big Greene", "Ice", "Sammy", "Alocate Blacky", "Pinky Nokia", "Shred", "Hand", "Pillow", "Maxwell", "Coffee", "Tom the TV", "Ella the Lamp", "Sam the Fan", "Pebbles", "Spots", "Wrench", "Lego Bubble Man", "General Ian", "A-Boy", "Adesh", "Candy Girl", "Butthurst", "Clocky", "Leafy", "Father Shell", "Flowery", "Bushy", "Mother Shell", "Girl Shell", "Boy Shell", "Black Rubberband", "Blue Rubberband", "Pink Rubberband", "Soap", "Sponge", "Boxy the Meep", "Randy the Cardboard", "Slippers #1", "Slippers #2", "Black Perfume", "Klipper", "Klipper's Wife", "Evil Klipper", "Clothy", "Randy", "Darkness", "Mr. Money Mouse", "Black Marker", "Cover", "Black Cover", "Grandpa Mud-Man", "Ray", "Billy", "Lizzy", "Butterclay", "Messi", "Renii", "Black", "Blue", "Energy Pen Ninja", "Air Pen Ninja", "Earth Pen Ninja", "Lightning Pen Ninja", "Ice Pen Ninja", "Fire Pen Ninja", "Master Ian", "Dark Vogue", "Rocket Launcher", "Bounce", "Toothbrush", "Toothpaste", "Thirsty", "Brian The Fool", "Stephen Jeffers", "Mcseen Jeffers", "Doctor Deadpool", "Godzilla", "Point", "Oddsketeer Cat", "Gamer"];

    const assets = { road: new Image(), magnet: new Image(), shield: new Image(), multiplier: new Image(), obsLow: new Image(), obsHigh: new Image(), coin: new Image() };
    assets.road.src = 'images/road.png'; assets.magnet.src = 'images/magnet.png'; assets.shield.src = 'images/shield.png'; assets.multiplier.src = 'images/multiplier.png'; assets.obsLow.src = 'images/obstacle_low.png'; assets.obsHigh.src = 'images/obstacle_high.png'; assets.coin.src = 'images/coin.png';

    const sounds = {
        bg: new Audio('images/bg_music.mp3'), magnet: new Audio('images/powerup_magnet.mp3'), shield: new Audio('images/powerup_shield.mp3'), 
        multiplier: new Audio('images/powerup_multiplier.mp3'), death: new Audio('images/death.mp3'), coin: new Audio('images/coin_ping.mp3'), 
        oink: new Audio('images/oink.mp3'), levelUp: new Audio('images/level_up.mp3')
    };
    sounds.bg.loop = true;
    let isMuted = false;

    // --- PROGRESSION SYSTEM ---
    let playerLevel = parseInt(localStorage.getItem('casta_level')) || 1;
    let currentTask = { type: 'coin', goal: 10, count: 0, text: "" };

    function generateNewTask() {
        const types = ['coin', 'jump', 'slide', 'score', 'powerup'];
        const randomType = types[Math.floor(Math.random() * types.length)];
        const multiplier = 1 + Math.floor(playerLevel / 5);

        switch(randomType) {
            case 'coin': currentTask = { type: 'coin', goal: 15 * multiplier, count: 0, text: `Collect ${15 * multiplier} Coins` }; break;
            case 'jump': currentTask = { type: 'jump', goal: 10 * multiplier, count: 0, text: `Jump ${10 * multiplier} Times` }; break;
            case 'slide': currentTask = { type: 'slide', goal: 10 * multiplier, count: 0, text: `Slide ${10 * multiplier} Times` }; break;
            case 'score': currentTask = { type: 'score', goal: 5000 * multiplier, count: 0, text: `Reach Score ${5000 * multiplier}` }; break;
            case 'powerup': currentTask = { type: 'powerup', goal: 3 * multiplier, count: 0, text: `Get ${3 * multiplier} Powerups` }; break;
        }
        updateTaskUI();
    }

    function checkTaskProgress(type, amount = 1) {
        if (currentTask.type === type) {
            currentTask.count += amount;
            if (currentTask.count >= currentTask.goal) {
                levelUpPlayer();
            }
            updateTaskUI();
        }
    }

    function levelUpPlayer() {
        playerLevel++;
        localStorage.setItem('casta_level', playerLevel);
        
        // Reward: 1000 coins + bonus per level
        const reward = 1000 + (playerLevel * 50);
        totalCoins += reward;
        localStorage.setItem('casta_bank', totalCoins);
        
        // Visual/Audio Feedback
        const msg = document.getElementById('levelUpMsg');
        msg.classList.add('show');
        if(!isMuted) sounds.levelUp?.play().catch(()=>{});
        setTimeout(() => msg.classList.remove('show'), 2500);
        
        generateNewTask();
    }

    function updateTaskUI() {
        document.getElementById('curLvl').innerText = playerLevel;
        document.getElementById('menuLvl').innerText = playerLevel;
        document.getElementById('taskText').innerText = `${currentTask.text} (${currentTask.count}/${currentTask.goal})`;
    }

    // --- CORE GAME VARIABLES ---
    let gameState = 'menu', score = 0, coins = 0, lastTime = 0;
    let totalCoins = parseInt(localStorage.getItem('casta_bank')) || 0;
    let highScore = parseInt(localStorage.getItem('casta_high')) || 0;
    let currentLane = 1, visualX = 0, speed = 8, roadScrollY = 0, entities = [], runCycle = 0;
    let powerTimer = 0, activePower = null, playerYOffset = 0, playerJumpVal = 0, isSliding = false, slideTimer = 0;
    let reviveCost = 5, isPaused = false, currentPreviewingChar = null;

    let characters = [];
    for(let i=1; i<=275; i++){
        characters.push({ 
            id: i, name: castaNames[i-1] || `Casta #${i}`, imgSrc: `images/casta${i}.png`, img: null,
            cost: i===1 ? 0 : i*100, unlocked: i===1 || localStorage.getItem('unlocked_'+i) === 'true', color: `hsl(${i*37}, 70%, 50%)` 
        });
    }

    let selectedChar = characters[0];
    selectedChar.img = new Image(); selectedChar.img.src = selectedChar.imgSrc;

    function openPreviewer(char) {
        currentPreviewingChar = char;
        document.getElementById('previewName').innerText = char.name;
        document.getElementById('largeImg').src = char.imgSrc;
        const ability = document.getElementById('abilityText');
        if(char.name === "Super Magnet") ability.innerText = "â­ ABILITY: PERMANENT MAGNET";
        else if(char.name === "Bella The Pig") ability.innerText = "â­ ABILITY: 2X COINS & OINK!";
        else ability.innerText = "";
        const btn = document.getElementById('previewActionBtn');
        const status = document.getElementById('previewStatus');
        if(char.unlocked) { status.innerText = "UNLOCKED"; status.style.color = "#00ff00"; btn.innerText = "SELECT"; }
        else { status.innerText = `COST: ðŸª™${char.cost}`; status.style.color = "#ffd700"; btn.innerText = "BUY"; }
        document.getElementById('previewer').style.display = 'flex';
    }

    function handlePreviewAction() {
        const char = currentPreviewingChar;
        if(char.unlocked) { selectedChar = char; if(!char.img) { char.img = new Image(); char.img.src = char.imgSrc; } closePreviewer(); initMenu(); }
        else if(totalCoins >= char.cost) {
            totalCoins -= char.cost; char.unlocked = true;
            localStorage.setItem('unlocked_'+char.id, 'true');
            localStorage.setItem('casta_bank', totalCoins);
            openPreviewer(char); initMenu();
        } else { alert("NOT ENOUGH COINS!"); }
    }

    function closePreviewer() { document.getElementById('previewer').style.display = 'none'; }
    function checkCheat() { const code = prompt("ENTER CODE:"); if(code === "CAU75") { characters.forEach(c => { c.unlocked = true; localStorage.setItem('unlocked_'+c.id, 'true'); }); totalCoins += 99999; localStorage.setItem('casta_bank', totalCoins); alert("ALL UNLOCKED!"); initMenu(); } }

    function initMenu() {
        const grid = document.getElementById('charGrid'); grid.innerHTML = '';
        document.getElementById('totalCoinsDisplay').innerText = totalCoins;
        document.getElementById('highScoreDisplay').innerText = Math.floor(highScore);
        updateTaskUI();
        characters.forEach(c => {
            const card = document.createElement('div');
            card.className = `char-card ${selectedChar.id===c.id?'selected':''}`;
            card.innerHTML = `<div style="font-size: 8px; color: #00ff00; margin-bottom: 2px;">${c.name}</div>
                <div style="width:40px;height:40px;background:${c.color};margin:auto;border-radius:4px;overflow:hidden;">
                    <img src="${c.imgSrc}" loading="lazy" style="width:100%;height:100%;object-fit:contain;" onerror="this.style.display='none';">
                </div>`;
            card.onclick = () => openPreviewer(c);
            grid.appendChild(card);
        });
    }

    function togglePause() {
        if(gameState !== 'playing') return;
        isPaused = !isPaused;
        document.getElementById('pauseBtn').innerText = isPaused ? 'RESUME' : 'PAUSE';
        if(isPaused) sounds.bg.pause(); else if(!isMuted) sounds.bg.play().catch(()=>{});
    }

    function toggleMute() { isMuted = !isMuted; Object.values(sounds).forEach(s => { if(s) s.muted = isMuted; }); document.getElementById('muteBtn').innerText = isMuted ? 'ðŸ”‡' : 'ðŸ”Š'; }

    function startGame() {
        document.getElementById('menu').style.display = 'none';
        score = 0; coins = 0; entities = []; currentLane = 1; speed = 8;
        visualX = (canvas.width / 3) + (canvas.width / 6) - 35;
        powerTimer = 0; activePower = null; playerYOffset = 0; reviveCost = 5; isPaused = false;
        generateNewTask(); // Get a fresh random mission
        lastTime = performance.now();
        if(!isMuted) { 
            sounds.bg.currentTime = 0; sounds.bg.play().catch(()=>{});
            if(selectedChar.name === "Bella The Pig") sounds.oink.play().catch(()=>{});
        }
        gameState = 'playing'; update();
    }

    function revivePlayer() {
        if (totalCoins >= reviveCost) {
            totalCoins -= reviveCost; localStorage.setItem('casta_bank', totalCoins);
            reviveCost *= 2; document.getElementById('reviveMenu').style.display = 'none';
            entities = []; gameState = 'playing';
            if(!isMuted) sounds.bg.play().catch(()=>{});
            lastTime = performance.now(); update();
        } else { alert("Not enough coins!"); }
    }

    function endGamePermanently() {
        document.getElementById('reviveMenu').style.display = 'none';
        document.getElementById('menu').style.display = 'flex';
        if(score > highScore) { highScore = score; localStorage.setItem('casta_high', highScore); }
        totalCoins += coins; localStorage.setItem('casta_bank', totalCoins);
        initMenu();
    }

    let tStart = {x:0, y:0};
    window.addEventListener('touchstart', e => { tStart.x = e.touches[0].clientX; tStart.y = e.touches[0].clientY; }, {passive: false});
    window.addEventListener('touchend', e => {
        if(gameState !== 'playing' || isPaused) return;
        let dx = e.changedTouches[0].clientX - tStart.x, dy = e.changedTouches[0].clientY - tStart.y;
        if(Math.abs(dx) > Math.abs(dy)){
            if(dx > 30 && currentLane < 2) currentLane++;
            if(dx < -30 && currentLane > 0) currentLane--;
        } else {
            if(dy < -30 && playerYOffset === 0) { playerJumpVal = 22; checkTaskProgress('jump'); }
            if(dy > 30) { isSliding = true; slideTimer = 35; if(playerYOffset < 0) playerJumpVal = -15; checkTaskProgress('slide'); } 
        }
    });

    function update(timestamp) {
        if(gameState !== 'playing' || isPaused) { if(isPaused) requestAnimationFrame(update); return; }
        ctx.clearRect(0,0,canvas.width, canvas.height);
        let delta = (timestamp - lastTime) / 1000;
        if(!isNaN(delta)) {
            let scoreGain = (activePower === 'MULTIPLIER') ? 200 : 100;
            score += scoreGain * delta; runCycle += delta * 5;
            roadScrollY += speed; if(roadScrollY >= canvas.height) roadScrollY = 0;
            if(Math.floor(score) % 100 === 0) checkTaskProgress('score', 100);
        }
        lastTime = timestamp;

        if(assets.road.complete && assets.road.width > 0) {
            ctx.drawImage(assets.road, 0, roadScrollY, canvas.width, canvas.height);
            ctx.drawImage(assets.road, 0, roadScrollY - canvas.height, canvas.width, canvas.height);
        } else { ctx.fillStyle = '#111'; ctx.fillRect(0,0,canvas.width,canvas.height); }

        let targetX = currentLane * (canvas.width / 3) + (canvas.width / 6) - 35;
        visualX += (targetX - visualX) * 0.15;
        if(playerJumpVal !== 0 || playerYOffset < 0){
            playerYOffset -= playerJumpVal; playerJumpVal -= 1.2;
            if(playerYOffset > 0) { playerYOffset = 0; playerJumpVal = 0; }
        }
        if(isSliding) { slideTimer--; if(slideTimer <= 0) isSliding = false; }

        if(Math.floor(score/10) % 7 === 0 && Math.random() < 0.15) {
            let lane = Math.floor(Math.random()*3);
            let r = Math.random();
            let type = r > 0.94 ? 'magnet' : (r > 0.88 ? 'shield' : (r > 0.82 ? 'multiplier' : (r > 0.4 ? 'coin' : (Math.random() > 0.5 ? 'obsLow' : 'obsHigh'))));
            entities.push({ lane, x: lane * (canvas.width/3) + (canvas.width/6) - 20, y: -100, type });
        }

        entities.forEach((en, i) => {
            en.y += speed;
            if((activePower === 'MAGNET' || (selectedChar.name === "Super Magnet" && selectedChar.unlocked)) && en.type === 'coin') {
                en.x += (visualX + 15 - en.x) * 0.25;
            }
            let img = assets[en.type];
            if(img && img.complete && img.width > 0) ctx.drawImage(img, en.x, en.y, 50, 50);
            
            let midY = canvas.height / 2;
            if(Math.abs(en.x - (visualX+10)) < 45 && en.y > midY + playerYOffset && en.y < midY + 120) {
                if(en.type === 'coin') {
                    // FIX: Reinforce sound playing
                    if(!isMuted) { sounds.coin.currentTime = 0; sounds.coin.play().catch(()=>{}); }
                    let coinVal = (activePower === 'MULTIPLIER' ? 3 : 1);
                    if(selectedChar.name === "Bella The Pig") coinVal *= 2;
                    coins += coinVal;
                    checkTaskProgress('coin', coinVal);
                    entities.splice(i, 1);
                } else if(en.type.startsWith('obs')) {
                    if(!((en.type === 'obsLow' && playerYOffset < -35) || (en.type === 'obsHigh' && isSliding))) {
                        if(activePower === 'SHIELD') { activePower = null; powerTimer = 0; entities.splice(i, 1); }
                        else { triggerDeath(); }
                    }
                } else {
                    activePower = en.type.toUpperCase(); powerTimer = 600;
                    if(!isMuted && sounds[en.type.toLowerCase()]) { sounds[en.type.toLowerCase()].currentTime = 0; sounds[en.type.toLowerCase()].play().catch(()=>{}); }
                    checkTaskProgress('powerup', 1);
                    entities.splice(i, 1);
                }
            }
            if(en.y > canvas.height) entities.splice(i,1);
        });

        let swirlX = Math.sin(runCycle * Math.PI) * 15;
        let stretch = Math.sin(runCycle * Math.PI * 2) * 0.1;
        ctx.save();
        ctx.translate(visualX + 35 + swirlX, (canvas.height / 2) + playerYOffset + 50);
        ctx.rotate((targetX - visualX) * 0.05); 
        if(isSliding) { ctx.scale(1.4, 0.4); ctx.translate(0, 50); }
        else if(playerYOffset < -10) { ctx.scale(0.8, 1.2); }
        else { ctx.scale(1 + stretch, 1 - stretch); }

        if(selectedChar.img && selectedChar.img.complete && selectedChar.img.naturalWidth !== 0) {
            ctx.drawImage(selectedChar.img, -35, -50, 70, 100);
        } else { ctx.fillStyle = selectedChar.color || 'green'; ctx.fillRect(-35, -50, 70, 100); }
        ctx.restore();

        const notify = document.getElementById('powerNotify');
        if(powerTimer > 0) {
            powerTimer--;
            if(activePower === 'MULTIPLIER') { notify.innerText = "SCORE X2 & BONUS COINS!"; notify.style.color = "#fbff00"; }
            else if(activePower === 'SHIELD') { notify.innerText = "SHIELD ACTIVE"; notify.style.color = "#00ffff"; }
            else if(activePower === 'MAGNET') { notify.innerText = "MAGNET ON"; notify.style.color = "#ff00ff"; }
        } else { activePower = null; notify.innerText = (selectedChar.name === "Super Magnet" && selectedChar.unlocked) ? "MAGNET ALWAYS ON" : ""; notify.style.color = "white"; }
        
        speed += 0.001;
        document.getElementById('coinCount').innerText = coins;
        document.getElementById('scoreDisplay').innerText = Math.floor(score);
        requestAnimationFrame(update);
    }

    function triggerDeath() { gameState = 'revive'; sounds.bg.pause(); if(!isMuted) sounds.death.play().catch(()=>{}); document.getElementById('reviveCostText').innerText = reviveCost; document.getElementById('reviveMenu').style.display = 'flex'; }
    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    initMenu();
</script>
</body>
    </html>
