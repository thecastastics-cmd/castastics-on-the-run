<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castastics Vertical Run</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        canvas { display: block; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; pointer-events: none; z-index: 10; font-weight: bold; text-shadow: 2px 2px #000; }
        #menu { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; color: white; }
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-height: 40vh; overflow-y: auto; padding: 20px; }
        .card { border: 2px solid #555; padding: 10px; text-align: center; background: #111; border-radius: 8px; }
        .selected { border-color: #00ff00; }
        button { padding: 15px 40px; font-size: 20px; background: #00ff00; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="ui">
    <div>COINS: <span id="coins">0</span></div>
    <div>SCORE: <span id="score">0</span></div>
    <div id="powerNotify" style="color: #00ffff;"></div>
</div>

<div id="menu">
    <h1>CASTASTICS</h1>
    <div id="totalBank">Bank: ðŸª™ 0</div>
    <div class="char-grid" id="charGrid"></div>
    <button onclick="startGame()">START RUN</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- IMAGE OVERRIDES ---
// Replace these URLs with your actual image paths
const imgAssets = {
    sky: new Image(), 
    road: new Image(),
    magnet: new Image(),
    multiplier: new Image(),
    shield: new Image()
};
imgAssets.sky.src = 'images/sky.png'; // Your Sky Image
imgAssets.road.src = 'images/road.png'; // Your Road Image
imgAssets.magnet.src = 'images/magnet.png';
imgAssets.multiplier.src = 'images/x2.png';
imgAssets.shield.src = 'images/shield.png';

let gameState = 'menu';
let score = 0;
let coins = 0;
let totalCoins = parseInt(localStorage.getItem('c_coins')) || 0;
let currentLane = 1; // 0: Left, 1: Middle, 2: Right
const laneWidth = () => canvas.width / 3;

// Powerup States
let activePower = null;
let powerTimer = 0;

// Character Setup
let characters = [];
for(let i=1; i<=105; i++) {
    let img = new Image();
    img.src = `images/casta${i}.png`;
    characters.push({ id: i, img: img, cost: i*50, unlocked: i===1 });
}
let selectedChar = characters[0];

// Game Objects
let entities = []; // Obstacles and Coins
let roadOffset = 0;

function startGame() {
    document.getElementById('menu').style.display = 'none';
    score = 0; coins = 0; entities = []; currentLane = 1;
    gameState = 'playing';
    animate();
}

// --- CONTROLS ---
let touchStart = { x: 0, y: 0 };
window.addEventListener('touchstart', e => {
    touchStart.x = e.touches[0].clientX;
    touchStart.y = e.touches[0].clientY;
});

window.addEventListener('touchend', e => {
    if(gameState !== 'playing') return;
    let dx = e.changedTouches[0].clientX - touchStart.x;
    let dy = e.changedTouches[0].clientY - touchStart.y;

    if (Math.abs(dx) > Math.abs(dy)) {
        if (dx > 30 && currentLane < 2) currentLane++; // Swipe Right
        if (dx < -30 && currentLane > 0) currentLane--; // Swipe Left
    } else {
        if (dy < -30) /* Jump Logic could go here */;
        if (dy > 30) /* Slide Logic could go here */;
    }
});

function animate() {
    if(gameState !== 'playing') return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 1. Draw Sky
    if (imgAssets.sky.complete && imgAssets.sky.width > 0) {
        ctx.drawImage(imgAssets.sky, 0, 0, canvas.width, canvas.height * 0.4);
    } else {
        ctx.fillStyle = '#1a1a2e';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // 2. Draw Road (Scrolling)
    roadOffset += 10;
    if (imgAssets.road.complete && imgAssets.road.width > 0) {
        let rH = canvas.height * 0.6;
        let rY = canvas.height * 0.4;
        ctx.drawImage(imgAssets.road, 0, rY + (roadOffset % 100), canvas.width, rH);
    } else {
        ctx.fillStyle = '#333';
        ctx.fillRect(0, canvas.height * 0.4, canvas.width, canvas.height * 0.6);
        // Lane Lines
        ctx.strokeStyle = "white";
        ctx.setLineDash([20, 20]);
        ctx.beginPath();
        ctx.moveTo(canvas.width/3, canvas.height*0.4); ctx.lineTo(canvas.width/3, canvas.height);
        ctx.moveTo(2*canvas.width/3, canvas.height*0.4); ctx.lineTo(2*canvas.width/3, canvas.height);
        ctx.stroke();
    }

    // 3. Spawning
    if (score % 40 === 0) {
        let lane = Math.floor(Math.random() * 3);
        let type = Math.random() > 0.8 ? 'magnet' : (Math.random() > 0.1 ? 'coin' : 'rock');
        entities.push({ lane, y: -50, type });
    }

    // 4. Update Entities
    entities.forEach((ent, i) => {
        ent.y += 8;
        let x = ent.lane * laneWidth() + laneWidth()/2 - 20;

        if (ent.type === 'coin') {
            ctx.fillStyle = "gold";
            ctx.beginPath(); ctx.arc(x+20, ent.y+20, 15, 0, Math.PI*2); ctx.fill();
        } else if (ent.type === 'rock') {
            ctx.fillStyle = "red";
            ctx.fillRect(x, ent.y, 40, 40);
        } else {
            // Powerup Image
            let pImg = imgAssets[ent.type];
            if(pImg.complete) ctx.drawImage(pImg, x, ent.y, 40, 40);
        }

        // Collision
        if (ent.lane === currentLane && ent.y > canvas.height - 150 && ent.y < canvas.height - 80) {
            if (ent.type === 'coin') { coins++; entities.splice(i, 1); }
            else if (ent.type === 'rock') { gameOver(); }
            else { activePower = ent.type; powerTimer = 500; entities.splice(i, 1); }
        }

        if (ent.y > canvas.height) entities.splice(i, 1);
    });

    // 5. Draw Player
    let playerX = currentLane * laneWidth() + laneWidth()/2 - 25;
    ctx.drawImage(selectedChar.img, playerX, canvas.height - 150, 50, 80);

    score++;
    document.getElementById('score').innerText = score;
    document.getElementById('coins').innerText = coins;
    requestAnimationFrame(animate);
}

function gameOver() {
    gameState = 'menu';
    totalCoins += coins;
    localStorage.setItem('c_coins', totalCoins);
    document.getElementById('menu').style.display = 'flex';
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

window.addEventListener('resize', resize);
resize();
</script>
</body>
</html>
