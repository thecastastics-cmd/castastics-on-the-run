<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castastics Master Runner</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; touch-action: none; color: white; }
        #gameUI { position: absolute; top: 10px; left: 15px; z-index: 10; pointer-events: none; text-shadow: 2px 2px #000; width: 100%; }
        #menu, #reviveMenu { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; padding: 20px; text-align: center; }
        #reviveMenu { display: none; z-index: 25; }
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; max-height: 40vh; overflow-y: scroll; padding: 10px; border: 2px solid #444; background: #111; width: 90%; border-radius: 10px; }
        .char-card { border: 2px solid #444; padding: 8px; text-align: center; border-radius: 8px; background: #222; font-size: 10px; }
        .char-card.selected { border-color: #00ff00; background: #004400; }
        button { padding: 18px 40px; font-size: 22px; background: #00ff00; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; color: #000; margin: 5px; }
        .secondary-btn { background: #555; color: white; font-size: 16px; padding: 10px 25px; }
        #muteBtn { position: absolute; bottom: 20px; right: 20px; background: #333; color: white; border-radius: 50%; width: 45px; height: 45px; border: none; z-index: 30; }
        #pauseBtn { position: absolute; top: 15px; right: 15px; z-index: 30; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 15px; border-radius: 5px; pointer-events: auto; }
    </style>
</head>
<body>

<div id="gameUI">
    <div style="color: #ffd700; font-size: 28px;">ðŸª™ <span id="coinCount">0</span></div>
    <div style="font-size: 14px; opacity:0.8; color: #00ff00;">BEST: <span id="highScoreDisplay">0</span></div>
    <div style="font-size: 18px;">SCORE: <span id="scoreDisplay">0</span></div>
    <div id="powerNotify" style="font-weight:bold; margin-top:5px; text-shadow: 0 0 5px #000;"></div>
    <button id="pauseBtn" onclick="togglePause()">PAUSE</button>
</div>

<div id="menu">
    <h1 style="color:#00ff00; margin: 0; font-style: italic; cursor: pointer; pointer-events: auto;" onclick="checkCheat()">CASTASTICS</h1>
    <div style="color:#ffd700; margin: 5px 0;">BANK: ðŸª™ <span id="totalCoinsDisplay">0</span></div>
    <div class="char-grid" id="charGrid"></div>
    <button onclick="startGame()">RUN!</button>
</div>

<div id="reviveMenu">
    <h2 style="color:#ffd700;">CRASHED!</h2>
    <p>Revive for ðŸª™ <span id="reviveCostText">5</span>?</p>
    <button onclick="revivePlayer()">REVIVE</button>
    <button class="secondary-btn" onclick="endGamePermanently()">NO THANKS</button>
</div>

<button id="muteBtn" onclick="toggleMute()">ðŸ”Š</button>
<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const assets = { 
        road: new Image(), magnet: new Image(), shield: new Image(), 
        multiplier: new Image(), obsLow: new Image(), obsHigh: new Image(), coin: new Image()
    };
    assets.road.src = 'images/road.png'; 
    assets.magnet.src = 'images/magnet.png';
    assets.shield.src = 'images/shield.png';
    assets.multiplier.src = 'images/multiplier.png';
    assets.obsLow.src = 'images/obstacle_low.png';
    assets.obsHigh.src = 'images/obstacle_high.png';
    assets.coin.src = 'images/coin.png';

    const sounds = {
        bg: new Audio('images/bg_music.mp3'), magnet: new Audio('images/powerup_magnet.mp3'),
        shield: new Audio('images/powerup_shield.mp3'), multiplier: new Audio('images/powerup_multiplier.mp3'),
        death: new Audio('images/death.mp3'), coin: new Audio('images/coin_ping.mp3')
    };
    sounds.bg.loop = true;
    let isMuted = false;

    let gameState = 'menu', score = 0, coins = 0, lastTime = 0;
    let totalCoins = parseInt(localStorage.getItem('casta_bank')) || 0;
    let highScore = parseInt(localStorage.getItem('casta_high')) || 0;
    let currentLane = 1, visualX = 0, speed = 8, roadScrollY = 0, entities = [], runCycle = 0;
    let powerTimer = 0, activePower = null, playerYOffset = 0, playerJumpVal = 0, isSliding = false, slideTimer = 0;
    
    let reviveCost = 5;
    let isPaused = false;

    let characters = [];
    const namingTiers = ["Squire", "Rogue", "Knight", "Mage", "Royal", "Celestial", "Eternal"];
    
    for(let i=1; i<=275; i++){
        let img = new Image(); 
        img.src = `images/casta${i}.png`;
        let tierIndex = Math.min(Math.floor((i-1)/40), 6);
        
        characters.push({ 
            id: i, 
            name: `${namingTiers[tierIndex]} #${i}`, 
            img: img, 
            cost: i===1 ? 0 : i*100, 
            unlocked: i===1 || localStorage.getItem('unlocked_'+i) === 'true', 
            color: `hsl(${i*37}, 70%, 50%)` 
        });
    }
    let selectedChar = characters[0];

    // Cheat Function
    function checkCheat() {
        const code = prompt("ENTER CODE:");
        if(code === "CAU75") {
            characters.forEach(c => {
                c.unlocked = true;
                localStorage.setItem('unlocked_'+c.id, 'true');
            });
            alert("ALL CHARACTERS UNLOCKED!");
            initMenu();
        }
    }

    function initMenu() {
        const grid = document.getElementById('charGrid'); grid.innerHTML = '';
        document.getElementById('totalCoinsDisplay').innerText = totalCoins;
        document.getElementById('highScoreDisplay').innerText = Math.floor(highScore);
        characters.forEach(c => {
            const card = document.createElement('div');
            card.className = `char-card ${selectedChar.id===c.id?'selected':''}`;
            card.innerHTML = `<div style="font-size: 8px; color: #00ff00; margin-bottom: 2px;">${c.name}</div><div style="width:40px;height:40px;background:${c.color};margin:auto;border-radius:4px;overflow:hidden;"><img src="${c.img.src}" style="width:100%;height:100%;object-fit:contain;" onerror="this.style.display='none'"></div><div style="margin-top:4px;">${c.unlocked?'SELECT':'ðŸª™'+c.cost}</div>`;
            card.onclick = () => { if(c.unlocked){ selectedChar = c; initMenu(); } else if(totalCoins >= c.cost){ totalCoins -= c.cost; c.unlocked = true; localStorage.setItem('unlocked_'+c.id, 'true'); localStorage.setItem('casta_bank', totalCoins); initMenu(); } };
            grid.appendChild(card);
        });
    }

    function togglePause() {
        if(gameState !== 'playing') return;
        isPaused = !isPaused;
        document.getElementById('pauseBtn').innerText = isPaused ? 'RESUME' : 'PAUSE';
        if(isPaused) sounds.bg.pause(); else if(!isMuted) sounds.bg.play().catch(()=>{});
    }

    function toggleMute() {
        isMuted = !isMuted; Object.values(sounds).forEach(s => s.muted = isMuted);
        document.getElementById('muteBtn').innerText = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
    }

    function startGame() {
        document.getElementById('menu').style.display = 'none';
        score = 0; coins = 0; entities = []; currentLane = 1; speed = 8; roadScrollY = 0;
        visualX = (canvas.width / 3) + (canvas.width / 6) - 35;
        powerTimer = 0; activePower = null; playerYOffset = 0; reviveCost = 5; isPaused = false;
        lastTime = performance.now();
        if(!isMuted) { sounds.bg.currentTime = 0; sounds.bg.play().catch(()=>{}); }
        gameState = 'playing';
        update();
    }

    function revivePlayer() {
        if (totalCoins >= reviveCost) {
            totalCoins -= reviveCost;
            localStorage.setItem('casta_bank', totalCoins);
            reviveCost *= 2;
            document.getElementById('reviveMenu').style.display = 'none';
            entities = [];
            gameState = 'playing';
            if(!isMuted) sounds.bg.play().catch(()=>{});
            lastTime = performance.now();
            update();
        } else {
            alert("Not enough coins!");
        }
    }

    function endGamePermanently() {
        document.getElementById('reviveMenu').style.display = 'none';
        document.getElementById('menu').style.display = 'flex';
        if(score > highScore) { highScore = score; localStorage.setItem('casta_high', highScore); }
        totalCoins += coins; localStorage.setItem('casta_bank', totalCoins);
        initMenu();
    }

    let tStart = {x:0, y:0};
    window.addEventListener('touchstart', e => { tStart.x = e.touches[0].clientX; tStart.y = e.touches[0].clientY; }, {passive: false});
    window.addEventListener('touchend', e => {
        if(gameState !== 'playing' || isPaused) return;
        let dx = e.changedTouches[0].clientX - tStart.x, dy = e.changedTouches[0].clientY - tStart.y;
        if(Math.abs(dx) > Math.abs(dy)){
            if(dx > 30 && currentLane < 2) currentLane++;
            if(dx < -30 && currentLane > 0) currentLane--;
        } else {
            if(dy < -30 && playerYOffset === 0) playerJumpVal = 22; 
            if(dy > 30) { isSliding = true; slideTimer = 35; if(playerYOffset < 0) playerJumpVal = -15; } 
        }
    });

    function update(timestamp) {
        if(gameState !== 'playing' || isPaused) {
            if(isPaused) requestAnimationFrame(update);
            return;
        }
        ctx.clearRect(0,0,canvas.width, canvas.height);
        let delta = (timestamp - lastTime) / 1000;
        if(!isNaN(delta)) {
            let scoreGain = (activePower === 'MULTIPLIER') ? 200 : 100;
            score += scoreGain * delta;
            runCycle += delta * 5;
            roadScrollY += speed; if(roadScrollY >= canvas.height) roadScrollY = 0;
        }
        lastTime = timestamp;

        if(assets.road.complete && assets.road.width > 0) {
            ctx.drawImage(assets.road, 0, roadScrollY, canvas.width, canvas.height);
            ctx.drawImage(assets.road, 0, roadScrollY - canvas.height, canvas.width, canvas.height);
        }

        let targetX = currentLane * (canvas.width / 3) + (canvas.width / 6) - 35;
        visualX += (targetX - visualX) * 0.15;

        if(playerJumpVal !== 0 || playerYOffset < 0){
            playerYOffset -= playerJumpVal; playerJumpVal -= 1.2;
            if(playerYOffset > 0) { playerYOffset = 0; playerJumpVal = 0; }
        }
        if(isSliding) { slideTimer--; if(slideTimer <= 0) isSliding = false; }

        if(Math.floor(score/10) % 7 === 0 && Math.random() < 0.15) {
            let lane = Math.floor(Math.random()*3);
            let r = Math.random();
            let type = r > 0.94 ? 'magnet' : (r > 0.88 ? 'shield' : (r > 0.82 ? 'multiplier' : (r > 0.4 ? 'coin' : (Math.random() > 0.5 ? 'obsLow' : 'obsHigh'))));
            entities.push({ lane, x: lane * (canvas.width/3) + (canvas.width/6) - 20, y: -100, type });
        }

        entities.forEach((en, i) => {
            en.y += speed;
            if(activePower === 'MAGNET' && en.type === 'coin') en.x += (visualX + 15 - en.x) * 0.25;
            let img = assets[en.type];
            if(img && img.complete && img.width > 0) ctx.drawImage(img, en.x, en.y, 50, 50);
            else { ctx.fillStyle = en.type === 'coin' ? '#ffd700' : '#ff00ff'; ctx.beginPath(); ctx.arc(en.x+25, en.y+25, 20, 0, Math.PI*2); ctx.fill(); }

            let midY = canvas.height / 2;
            if(Math.abs(en.x - visualX) < 55 && en.y > midY + playerYOffset && en.y < midY + 120) {
                if(en.type === 'coin') {
                    if(!isMuted) { sounds.coin.currentTime = 0; sounds.coin.play().catch(()=>{}); }
                    coins += (activePower === 'MULTIPLIER' ? 3 : 1);
                    entities.splice(i, 1);
                } else if(en.type.startsWith('obs')) {
                    if(!((en.type === 'obsLow' && playerYOffset < -35) || (en.type === 'obsHigh' && isSliding))) {
                        if(activePower === 'SHIELD') { activePower = null; powerTimer = 0; entities.splice(i, 1); }
                        else { triggerDeath(); }
                    }
                } else {
                    activePower = en.type.toUpperCase(); powerTimer = 600;
                    if(!isMuted && sounds[en.type.toLowerCase()]) { sounds[en.type.toLowerCase()].currentTime = 0; sounds[en.type.toLowerCase()].play().catch(()=>{}); }
                    entities.splice(i, 1);
                }
            }
            if(en.y > canvas.height) entities.splice(i,1);
        });

        let swirlX = Math.sin(runCycle * Math.PI) * 15;
        let stretch = Math.sin(runCycle * Math.PI * 2) * 0.1;
        
        ctx.save();
        ctx.translate(visualX + 35 + swirlX, (canvas.height / 2) + playerYOffset + 50);
        ctx.rotate((targetX - visualX) * 0.05); 
        
        if(isSliding) { ctx.scale(1.4, 0.4); ctx.translate(0, 50); }
        else if(playerYOffset < -10) { ctx.scale(0.8, 1.2); }
        else { ctx.scale(1 + stretch, 1 - stretch); }

        if(selectedChar.img.complete && selectedChar.img.width > 0) ctx.drawImage(selectedChar.img, -35, -50, 70, 100);
        else { ctx.fillStyle = selectedChar.color; ctx.fillRect(-35, -50, 70, 100); }
        ctx.restore();

        const notify = document.getElementById('powerNotify');
        if(powerTimer > 0) {
            powerTimer--;
            if(activePower === 'MULTIPLIER') { notify.innerText = "SCORE X2 & BONUS COINS!"; notify.style.color = "#fbff00"; }
            else if(activePower === 'SHIELD') { notify.innerText = "SHIELD ACTIVE"; notify.style.color = "#00ffff"; }
            else if(activePower === 'MAGNET') { notify.innerText = "MAGNET ON"; notify.style.color = "#ff00ff"; }
        } else { activePower = null; notify.innerText = ""; }

        speed += 0.001;
        document.getElementById('coinCount').innerText = coins;
        document.getElementById('scoreDisplay').innerText = Math.floor(score);
        requestAnimationFrame(update);
    }

    function triggerDeath() {
        gameState = 'revive';
        sounds.bg.pause();
        if(!isMuted) sounds.death.play().catch(()=>{});
        document.getElementById('reviveCostText').innerText = reviveCost;
        document.getElementById('reviveMenu').style.display = 'flex';
    }

    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    initMenu();
</script>
</body>
</html>
