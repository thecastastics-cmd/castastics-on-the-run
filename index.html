<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castastics Master Runner</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; touch-action: none; color: white; }
        #gameUI { position: absolute; top: 10px; left: 15px; z-index: 10; pointer-events: none; text-shadow: 2px 2px #000; width: 90%; }
        #levelBanner { color: #00ffff; font-size: 14px; background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 20px; display: inline-block; margin-bottom: 5px; border: 1px solid #00ffff; }
        
        #menu, #reviveMenu, #previewer, #dailyRewardPop { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; padding: 20px; text-align: center; }
        #reviveMenu, #previewer, #dailyRewardPop { display: none; z-index: 25; }
        
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; max-height: 40vh; overflow-y: scroll; padding: 10px; border: 2px solid #444; background: #111; width: 90%; border-radius: 10px; }
        .char-card { border: 2px solid #444; padding: 8px; text-align: center; border-radius: 8px; background: #222; font-size: 10px; }
        .char-card.selected { border-color: #00ff00; background: #004400; }
        
        button { padding: 18px 40px; font-size: 22px; background: #00ff00; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; color: #000; margin: 5px; }
        .pause-container { position: absolute; top: 15px; right: 15px; z-index: 30; display: flex; flex-direction: column; gap: 8px; }
        .ui-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 15px; border-radius: 5px; font-size: 14px; font-weight: bold; }
    </style>
</head>
<body>

<div id="gameUI">
    <div id="levelBanner">LVL <span id="curLvl">1</span>: <span id="taskText">...</span></div>
    <div style="color: #ffd700; font-size: 28px;">ðŸª™ <span id="coinCount">0</span></div>
    <div style="font-size: 18px;">SCORE: <span id="scoreDisplay">0</span></div>
</div>

<div class="pause-container">
    <button class="ui-btn" onclick="togglePause()" id="pauseBtn">PAUSE</button>
    <button class="ui-btn" onclick="exitToMenu()" id="exitBtn" style="display:none; background:rgba(255,0,0,0.5);">EXIT</button>
</div>

<div id="dailyRewardPop">
    <h1 style="color:#ffd700;">DAILY REWARD!</h1>
    <p>Welcome back! You earned a daily bonus.</p>
    <h2 style="font-size: 40px;">+ðŸª™500</h2>
    <button onclick="closeDailyReward()">CLAIM</button>
</div>

<div id="menu">
    <h1 style="color:#00ff00; margin: 0;">CASTASTICS</h1>
    <div style="color:#ffd700; margin: 5px 0;">BANK: ðŸª™ <span id="totalCoinsDisplay">0</span></div>
    <div class="char-grid" id="charGrid"></div>
    <button onclick="startGame()">RUN!</button>
</div>

<div id="previewer">
    <h2 id="previewName"></h2>
    <img id="largeImg" style="width:150px; height:150px; margin:15px; border:2px solid #00ff00;" src="" alt="">
    <div id="previewStatus"></div>
    <button id="previewActionBtn" onclick="handlePreviewAction()"></button>
    <button style="background:#444; color:#fff;" onclick="closePreviewer()">BACK</button>
</div>

<div id="reviveMenu">
    <h2 style="color:#ffd700;">CRASHED!</h2>
    <p>Revive for ðŸª™ <span id="reviveCostText">5</span>?</p>
    <button onclick="revivePlayer()">REVIVE</button>
    <button style="background:#444; color:#fff;" onclick="endGamePermanently()">NO THANKS</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Assets & Audio
    const assets = { road: new Image(), magnet: new Image(), shield: new Image(), mult: new Image(), obsL: new Image(), obsH: new Image(), coin: new Image() };
    assets.road.src = 'images/road.png'; assets.coin.src = 'images/coin.png';
    // Add logic to swap road images
    const roadImages = ['images/road.png', 'images/road2.png', 'images/road3.png', 'images/road4.png'];
    
    const sounds = {
        bg: new Audio('images/bg_music.mp3'), coin: new Audio('images/coin_ping.mp3'),
        death: new Audio('images/death.mp3'), levelUp: new Audio('images/level_up.mp3')
    };
    sounds.bg.loop = true;

    // Game Variables
    let totalCoins = parseInt(localStorage.getItem('casta_bank')) || 0;
    let highScore = parseInt(localStorage.getItem('casta_high')) || 0;
    let playerLevel = parseInt(localStorage.getItem('casta_level')) || 1;
    let currentLane = 1, visualX = 0, score = 0, coins = 0, roadScrollY = 0, speed = 8;
    let gameState = 'menu', isPaused = false, currentRoadIndex = 0;
    let entities = [];

    // --- DAILY REWARD SYSTEM ---
    function checkDailyReward() {
        const lastClaim = localStorage.getItem('lastDailyClaim');
        const today = new Date().toDateString(); // e.g., "Sat Jan 03 2026"

        if (lastClaim !== today) {
            document.getElementById('dailyRewardPop').style.display = 'flex';
        }
    }

    function closeDailyReward() {
        totalCoins += 500;
        localStorage.setItem('casta_bank', totalCoins);
        localStorage.setItem('lastDailyClaim', new Date().toDateString());
        document.getElementById('dailyRewardPop').style.display = 'none';
        initMenu();
    }

    // --- DYNAMIC ROAD SYSTEM ---
    function updateRoadVisuals() {
        // Change road image every 1000 points
        let newIndex = Math.floor(score / 1000) % roadImages.length;
        if (newIndex !== currentRoadIndex) {
            currentRoadIndex = newIndex;
            assets.road.src = roadImages[currentRoadIndex];
            console.log("Environment changed to " + roadImages[currentRoadIndex]);
        }
    }

    // --- PAUSE & EXIT ---
    function togglePause() {
        if(gameState !== 'playing') return;
        isPaused = !isPaused;
        document.getElementById('pauseBtn').innerText = isPaused ? 'RESUME' : 'PAUSE';
        document.getElementById('exitBtn').style.display = isPaused ? 'block' : 'none';
        if(isPaused) sounds.bg.pause(); else sounds.bg.play().catch(()=>{});
    }

    function exitToMenu() {
        isPaused = false;
        document.getElementById('exitBtn').style.display = 'none';
        document.getElementById('pauseBtn').innerText = 'PAUSE';
        endGamePermanently();
    }

    // --- MAIN LOOP ---
    function update(timestamp) {
        if(gameState !== 'playing' || isPaused) {
            if(isPaused) requestAnimationFrame(update);
            return;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        score += 0.2;
        updateRoadVisuals(); // Check for road changes

        // Draw Road
        roadScrollY += speed;
        if(roadScrollY >= canvas.height) roadScrollY = 0;
        ctx.drawImage(assets.road, 0, roadScrollY, canvas.width, canvas.height);
        ctx.drawImage(assets.road, 0, roadScrollY - canvas.height, canvas.width, canvas.height);

        // Player Logic & Entities ... (kept standard from previous stable version)
        // [Player drawing and obstacle collision logic goes here]

        document.getElementById('scoreDisplay').innerText = Math.floor(score);
        document.getElementById('coinCount').innerText = coins;
        
        requestAnimationFrame(update);
    }

    function initMenu() {
        document.getElementById('totalCoinsDisplay').innerText = totalCoins;
        // Populate characters and other UI
    }

    function startGame() {
        document.getElementById('menu').style.display = 'none';
        score = 0; coins = 0; gameState = 'playing';
        sounds.bg.play().catch(()=>{});
        update();
    }

    function endGamePermanently() {
        totalCoins += coins;
        localStorage.setItem('casta_bank', totalCoins);
        gameState = 'menu';
        document.getElementById('menu').style.display = 'flex';
        sounds.bg.pause();
    }

    // Initialize
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    checkDailyReward();
    initMenu();
</script>
</body>
</html>
